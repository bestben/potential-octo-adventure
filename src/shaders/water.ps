#version 330

uniform sampler2D atlas;
uniform int tileCount;
uniform int tileSize;

uniform float fogDistance;
uniform vec4 fogColor;

out vec4 out_color;

in vec3 ex_pos;
flat in int ex_voxel;
in vec3 ex_normal;
in vec4 view_pos;

void main() {    
    vec2 tileOffset = vec2(ex_voxel % tileCount, (ex_voxel%256) / tileCount);
    tileOffset = tileOffset / tileSize;
    
    vec2 tileUV = vec2(dot(ex_normal.zxy, ex_pos), dot(ex_normal.yzx, ex_pos));
    vec2 texCoord = tileOffset + fract(tileUV) / tileSize;
    
    vec4 texelAll = texture2D(atlas, texCoord);
    texelAll.a = 0.5;

    float minFogDist = fogDistance*0.5;
	float fogFactor = clamp((length(-view_pos)-minFogDist)/(fogDistance-minFogDist),0.0,1.0);

    out_color = mix(texelAll, fogColor, fogFactor);
}